const scriptUrl = document.querySelector('script[src*="arivubot.min.js"]').src;
const url = new URL(scriptUrl);
const apiKey = url.searchParams.get('apiKey');

if (apiKey !== '') {
    import('https://openfpcdn.io/fingerprintjs/v4')
        .then(FingerprintJS => {
            return FingerprintJS.load();
        })
        .then(fp => {
            return fp.get();
        })
        .then(result => {
            const userID = result.visitorId;

            // Create rootDiv
            const rootDiv = document.createElement('div');
            rootDiv.id = 'arivubot';
            rootDiv.style.border = 'none';
            rootDiv.style.position = 'fixed';
            rootDiv.style.flexDirection = 'column';
            rootDiv.style.justifyContent = 'space-between';
            rootDiv.style.boxShadow = 'rgba(150, 150, 150, 0.2) 0px 10px 30px 0px, rgba(150, 150, 150, 0.2) 0px 0px 0px 1px';
            rootDiv.style.bottom = '5rem';
            rootDiv.style.right = '1rem';
            rootDiv.style.width = '448px';
            rootDiv.style.height = '85dvh';
            rootDiv.style.maxHeight = '824px';
            rootDiv.style.borderRadius = '0.75rem';
            rootDiv.style.display = 'flex';
            rootDiv.style.zIndex = '2147483646';
            rootDiv.style.overflow = 'hidden';
            rootDiv.style.backgroundColor = 'white';
            rootDiv.style.left = 'unset';
            rootDiv.style.top = 'unset';
            rootDiv.style.display = 'none'; // Initially hidden
            document.body.appendChild(rootDiv);

            // Adjust styles for mobile view
            const applyMobileStyles = () => {
                if (window.matchMedia('(max-width: 768px)').matches) {
                    rootDiv.style.width = '96%';
                    rootDiv.style.height = '100dvh';
                    rootDiv.style.bottom = '5rem';
                    rootDiv.style.marginRight = '10px';
                    rootDiv.style.marginLeft = '10px';
                    rootDiv.style.right = '0';
                    rootDiv.style.borderRadius = '0';
                    rootDiv.style.borderRadius = '0.75rem';
                } else {
                    rootDiv.style.width = '448px';
                    rootDiv.style.height = '85dvh';
                    rootDiv.style.bottom = '5rem';
                    rootDiv.style.right = '1rem';
                    rootDiv.style.borderRadius = '0.75rem';
                }
            };

            applyMobileStyles();
            window.addEventListener('resize', applyMobileStyles);


            window.apiKey = apiKey;
            window.userId = userID;

            // Create iframe
            const iframe = document.createElement('iframe');
            // iframe.src = `http://localhost:5173/${apiKey}/${userID}`;
            iframe.src = `https://arivubot-widget.vercel.app`;
            iframe.style.height = '100%';
            iframe.style.width = '100%';
            iframe.style.border = 'none';
            iframe.style.display = 'block';
            iframe.setAttribute('frameborder', '0');
            rootDiv.appendChild(iframe);

            // Create chat button
            const chatButton = document.createElement('button');
            chatButton.type = 'button';
            chatButton.id = 'chatbase-bubble-button';
            chatButton.setAttribute('aria-label', 'chat-button');
            chatButton.style.position = 'fixed';
            chatButton.style.border = '0px';
            chatButton.style.bottom = '1rem';
            chatButton.style.right = '1rem';
            chatButton.style.width = '60px';
            chatButton.style.height = '60px';
            chatButton.style.borderRadius = '29.5px';
            chatButton.style.backgroundColor = 'rgb(0, 0, 0)';
            chatButton.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 4px 8px 0px';
            chatButton.style.cursor = 'pointer';
            chatButton.style.zIndex = '2147483645';
            chatButton.style.transition = '0.2s ease-in-out';
            chatButton.style.left = 'unset';
            chatButton.style.transform = 'scale(1)';

            // Add SVG to the button
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"  width="24px" height="24px">
<path d="M22 5C22 6.65685 20.6569 8 19 8C17.3431 8 16 6.65685 16 5C16 3.34315 17.3431 2 19 2C20.6569 2 22 3.34315 22 5Z" fill="green"/>
<path  d="M15.2347 2.53476C14.2201 2.1881 13.132 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39938 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88836 21.6244 10.4003 22 12 22C17.5228 22 22 17.5228 22 12C22 10.868 21.8119 9.77987 21.4652 8.76526C20.7572 9.22981 19.9101 9.5 19 9.5C16.5147 9.5 14.5 7.48528 14.5 5C14.5 4.08987 14.7702 3.24284 15.2347 2.53476Z" fill="#fff"/>
</svg>`;
            chatButton.innerHTML = svg;

            document.body.appendChild(chatButton);

            // Toggle iframe visibility on button click
            chatButton.addEventListener('click', () => {
                if (rootDiv.style.display === 'none') {
                    rootDiv.style.display = 'flex';
                    chatButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" style="margin-left:-5px;margin-bottom:-3px;" width="30px" height="30px" viewBox="0 0 24 24" fill="#fff">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M4.29289 8.29289C4.68342 7.90237 5.31658 7.90237 5.70711 8.29289L12 14.5858L18.2929 8.29289C18.6834 7.90237 19.3166 7.90237 19.7071 8.29289C20.0976 8.68342 20.0976 9.31658 19.7071 9.70711L12.7071 16.7071C12.3166 17.0976 11.6834 17.0976 11.2929 16.7071L4.29289 9.70711C3.90237 9.31658 3.90237 8.68342 4.29289 8.29289Z" fill="#fff"/>
            </svg>
        `;
                } else {
                    rootDiv.style.display = 'none';
                    chatButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="24px" height="24px">
            <path d="M22 5C22 6.65685 20.6569 8 19 8C17.3431 8 16 6.65685 16 5C16 3.34315 17.34315 2 19 2C20.6569 2 22 3.34315 22 5Z" fill="green"/>
            <path opacity="0.5" d="M15.2347 2.53476C14.2201 2.1881 13.132 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39938 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88836 21.6244 10.4003 22 12 22C17.5228 22 22 17.5228 22 12C22 10.868 21.8119 9.77987 21.4652 8.76526C20.7572 9.22981 19.9101 9.5 19 9.5C16.5147 9.5 14.5 7.48528 14.5 5C14.5 4.08987 14.7702 3.24284 15.2347 2.53476Z" fill="#fff"/>
        </svg>
    `;
                }
            });
        });
}
